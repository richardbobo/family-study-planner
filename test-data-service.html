<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®æœåŠ¡æµ‹è¯• - å­¦ä¹ è®¡åˆ’ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { color: #2ed573; background: #f0fff4; border-color: #2ed573; }
        .error { color: #ff6b6b; background: #fff5f5; border-color: #ff6b6b; }
        button { background: #4a69bd; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #3c5aa8; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ğŸ“Š æ•°æ®æœåŠ¡æµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>1. æ•°æ®æœåŠ¡åˆå§‹åŒ–</h3>
        <div id="initTest"></div>
        <button onclick="testInitialization()">æµ‹è¯•åˆå§‹åŒ–</button>
    </div>

    <div class="test-section">
        <h3>2. ä»»åŠ¡æ“ä½œæµ‹è¯•</h3>
        <div id="taskTest"></div>
        <button onclick="testTaskOperations()">æµ‹è¯•ä»»åŠ¡æ“ä½œ</button>
        <button onclick="cleanupTestData()">æ¸…ç†æµ‹è¯•æ•°æ®</button>
    </div>

    <div class="test-section">
        <h3>3. æ•°æ®æºåˆ‡æ¢æµ‹è¯•</h3>
        <div id="sourceTest"></div>
        <button onclick="testDataSourceSwitch()">æµ‹è¯•æ•°æ®æºåˆ‡æ¢</button>
    </div>

    <div class="test-section">
        <h3>4. æµ‹è¯•æ—¥å¿—</h3>
        <div class="log" id="testLog"></div>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/data-service.js"></script>
    <script src="js/family-service.js"></script>

    <script>
        const dataService = getDataService();
        let testLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            testLog.push({ message: logEntry, type });
            
            const logDiv = document.getElementById('testLog');
            logDiv.innerHTML = testLog.map(entry => 
                `<div class="${entry.type}">${entry.message}</div>`
            ).join('');
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            testLog = [];
            document.getElementById('testLog').innerHTML = '';
        }

        // 1. åˆå§‹åŒ–æµ‹è¯•
        async function testInitialization() {
            const resultDiv = document.getElementById('initTest');
            
            try {
                log('æµ‹è¯•æ•°æ®æœåŠ¡åˆå§‹åŒ–...');
                log(`å½“å‰æ•°æ®æº: ${dataService.getCurrentDataSource()}`);
                log(`æœåŠ¡åˆå§‹åŒ–çŠ¶æ€: ${dataService.isInitialized ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
                
                resultDiv.innerHTML = 'âœ… æ•°æ®æœåŠ¡åˆå§‹åŒ–æˆåŠŸ';
                resultDiv.className = 'test-section success';
                
            } catch (error) {
                resultDiv.innerHTML = `âŒ åˆå§‹åŒ–æµ‹è¯•å¤±è´¥: ${error.message}`;
                resultDiv.className = 'test-section error';
                log(`åˆå§‹åŒ–æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 2. ä»»åŠ¡æ“ä½œæµ‹è¯•
        async function testTaskOperations() {
            const resultDiv = document.getElementById('taskTest');
            
            try {
                log('å¼€å§‹ä»»åŠ¡æ“ä½œæµ‹è¯•...');
                
                // åˆ›å»ºæµ‹è¯•ä»»åŠ¡
                const testTask = {
                    name: 'æ•°æ®æœåŠ¡æµ‹è¯•ä»»åŠ¡',
                    subject: 'æ•°å­¦',
                    description: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ä»»åŠ¡',
                    date: new Date().toISOString().split('T')[0],
                    startTime: '19:00',
                    endTime: '20:00',
                    time: 60,
                    points: 10,
                    completed: false,
                    repeatType: 'once'
                };
                
                log('åˆ›å»ºæµ‹è¯•ä»»åŠ¡...');
                const createdTask = await dataService.createTask(testTask);
                log(`ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼ŒID: ${createdTask.id}`);
                
                // è·å–ä»»åŠ¡
                log('è·å–ä»»åŠ¡åˆ—è¡¨...');
                const tasks = await dataService.getTasks();
                log(`è·å–åˆ° ${tasks.length} ä¸ªä»»åŠ¡`);
                
                // æ›´æ–°ä»»åŠ¡
                log('æ›´æ–°ä»»åŠ¡çŠ¶æ€...');
                const updatedTask = await dataService.updateTask(createdTask.id, { 
                    completed: true,
                    completionTime: new Date().toISOString()
                });
                log(`ä»»åŠ¡æ›´æ–°æˆåŠŸ: ${updatedTask.completed}`);
                
                // éªŒè¯ä»»åŠ¡
                const verifiedTasks = await dataService.getTasks();
                const foundTask = verifiedTasks.find(t => t.id === createdTask.id);
                
                resultDiv.innerHTML = `
                    âœ… ä»»åŠ¡æ“ä½œæµ‹è¯•æˆåŠŸï¼<br>
                    - åˆ›å»ºä»»åŠ¡: ${createdTask.name}<br>
                    - è·å–ä»»åŠ¡: ${tasks.length} ä¸ª<br>
                    - æ›´æ–°ä»»åŠ¡: ${updatedTask.completed ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}<br>
                    - æ•°æ®æº: ${dataService.getCurrentDataSource()}
                `;
                resultDiv.className = 'test-section success';
                
                // ä¿å­˜æµ‹è¯•ä»»åŠ¡IDç”¨äºæ¸…ç†
                window.testTaskId = createdTask.id;
                
            } catch (error) {
                resultDiv.innerHTML = `âŒ ä»»åŠ¡æ“ä½œæµ‹è¯•å¤±è´¥: ${error.message}`;
                resultDiv.className = 'test-section error';
                log(`ä»»åŠ¡æ“ä½œæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 3. æ•°æ®æºåˆ‡æ¢æµ‹è¯•
        async function testDataSourceSwitch() {
            const resultDiv = document.getElementById('sourceTest');
            
            try {
                log('æµ‹è¯•æ•°æ®æºåˆ‡æ¢...');
                
                const originalSource = dataService.getCurrentDataSource();
                log(`åŸå§‹æ•°æ®æº: ${originalSource}`);
                
                // æ¨¡æ‹Ÿåˆ‡æ¢ï¼ˆå®é™…åº”è¯¥é€šè¿‡é…ç½®æ›´æ–°ï¼‰
                log('æ•°æ®æºåˆ‡æ¢åŠŸèƒ½å¾…é…ç½®æ›´æ–°å®ç°...');
                
                resultDiv.innerHTML = `
                    âœ… æ•°æ®æºåˆ‡æ¢æµ‹è¯•å®Œæˆ<br>
                    - å½“å‰æ•°æ®æº: ${originalSource}<br>
                    - åˆ‡æ¢åŠŸèƒ½: å¾…é…ç½®æ›´æ–°å®ç°
                `;
                resultDiv.className = 'test-section success';
                
            } catch (error) {
                resultDiv.innerHTML = `âŒ æ•°æ®æºåˆ‡æ¢æµ‹è¯•å¤±è´¥: ${error.message}`;
                resultDiv.className = 'test-section error';
                log(`æ•°æ®æºåˆ‡æ¢æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸…ç†æµ‹è¯•æ•°æ®
        async function cleanupTestData() {
            if (!window.testTaskId) {
                log('æ²¡æœ‰æµ‹è¯•æ•°æ®éœ€è¦æ¸…ç†', 'warning');
                return;
            }
            
            try {
                log('æ¸…ç†æµ‹è¯•æ•°æ®...');
                await dataService.deleteTask(window.testTaskId);
                log('æµ‹è¯•æ•°æ®æ¸…ç†å®Œæˆ');
                delete window.testTaskId;
            } catch (error) {
                log(`æ¸…ç†æµ‹è¯•æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
        document.addEventListener('DOMContentLoaded', function() {
            log('æ•°æ®æœåŠ¡æµ‹è¯•é¡µé¢å·²åŠ è½½');
            testInitialization();
        });
    </script>
</body>
</html>