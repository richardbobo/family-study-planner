// data-service-fixed.js - å®‰å…¨ç‰ˆæœ¬
class SafeDataService {
    constructor() {
        this.taskCreationCount = 0;
        this.maxTasksPerSession = 50;
        this.creationInProgress = false;
        this.lastCreationTime = 0;
        console.log('ğŸ›¡ï¸ å®‰å…¨æ•°æ®æœåŠ¡å·²åˆå§‹åŒ–');
    }
    
    async createTask(taskData) {
        // å®‰å…¨é˜²æŠ¤1ï¼šé˜²æ­¢é‡å¤è°ƒç”¨
        if (this.creationInProgress) {
            console.error('ğŸš¨ æ£€æµ‹åˆ°é‡å¤è°ƒç”¨');
            return Promise.reject(new Error('ä»»åŠ¡åˆ›å»ºæ­£åœ¨è¿›è¡Œä¸­'));
        }
        
        // å®‰å…¨é˜²æŠ¤2ï¼šé¢‘ç‡é™åˆ¶
        const now = Date.now();
        if (now - this.lastCreationTime < 1000) {
            console.error('ğŸš¨ åˆ›å»ºé¢‘ç‡è¿‡é«˜');
            return Promise.reject(new Error('åˆ›å»ºé¢‘ç‡è¿‡é«˜'));
        }
        
        // å®‰å…¨é˜²æŠ¤3ï¼šæ•°é‡é™åˆ¶
        this.taskCreationCount++;
        if (this.taskCreationCount > this.maxTasksPerSession) {
            console.error('ğŸš¨ åˆ›å»ºæ•°é‡è¶…é™');
            return Promise.reject(new Error('åˆ›å»ºæ•°é‡è¶…é™'));
        }
        
        this.creationInProgress = true;
        this.lastCreationTime = now;
        
        try {
            console.log(`ğŸ›¡ï¸ å®‰å…¨åˆ›å»ºä»»åŠ¡ ${this.taskCreationCount}/${this.maxTasksPerSession}`);
            
            const tasks = this.getTasksFromLocalStorage();
            const newTask = {
                ...taskData,
                id: 'safe_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                createdAt: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            tasks.push(newTask);
            this.saveTasksToLocalStorage(tasks);
            
            console.log('âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸ:', newTask.name);
            return newTask;
            
        } catch (error) {
            console.error('âŒ ä»»åŠ¡åˆ›å»ºå¤±è´¥:', error);
            return Promise.reject(error);
        } finally {
            this.creationInProgress = false;
        }
    }
    
    getTasksFromLocalStorage() {
        try {
            return JSON.parse(localStorage.getItem('studyTasks') || '[]');
        } catch (e) {
            return [];
        }
    }
    
    saveTasksToLocalStorage(tasks) {
        localStorage.setItem('studyTasks', JSON.stringify(tasks));
    }
    
    async deleteTask(taskId) {
        const tasks = this.getTasksFromLocalStorage();
        const filteredTasks = tasks.filter(task => task.id !== taskId);
        this.saveTasksToLocalStorage(filteredTasks);
        return true;
    }
    
    async getTasks() {
        return this.getTasksFromLocalStorage();
    }
}

// å®‰å…¨åˆå§‹åŒ–
let safeDataServiceInstance = null;
function getSafeDataService() {
    if (!safeDataServiceInstance) {
        safeDataServiceInstance = new SafeDataService();
    }
    return safeDataServiceInstance;
}

// æ›¿æ¢åŸæœ‰æœåŠ¡
window.dataService = getSafeDataService();
window.DataService = SafeDataService;
window.getDataService = getSafeDataService;

console.log('âœ… å®‰å…¨æ•°æ®æœåŠ¡å·²å°±ç»ª');